%section#main
  %section.container
    .row
      .col-md-12
        .panel.panel-default
          .panel-heading
            %h3.panel-title
              Temperaturas de hoy
          .panel-body.text-center
            #temperature-graph
    .row
      .col-md-4.col-xs-6
        .panel.panel-default
          .panel-heading
            %h3.panel-title
              Luz del escritorio
          .panel-body.text-center.large-switch-panel
            %input.input-lg{ :id => 'light-switch', :type => 'checkbox', 'checked' => enabled ? true : nil }

      .col-md-4.col-xs-6
        .panel.panel-default
          .panel-heading
            %h3.panel-title
              Color de la luz
          .panel-body.text-center
            %input.input-lg{ :id => 'color-selector', :type => 'color' }

      .col-md-4.col-xs-12
        .panel.panel-default
          .panel-heading
            %h3.panel-title
              Temperatura
          .panel-body.text-center
            %span{ :id => 'temperature' }
              = temperature
:javascript
  $(function() {
    var setSwitchState = function(state) {
      $('#light-switch').bootstrapSwitch('state', state, true);
    };

    $('#light-switch').bootstrapSwitch({size: 'large'});

    $('#light-switch').on('switchChange.bootstrapSwitch', function(event, checked) {
      if (checked) {
        $.post('/rgb');
      }
      else {
        $.post('/disable');
      }
    });

    $('#color-selector').change(function() {
      $.post('/rgb?' + $.param({ color: $(this).val()}));
      setSwitchState(true);
    });

    var graph = Morris.Line({
      element: 'temperature-graph',
      data: [],
      xkey: 'timestamp',
      ykeys: ['temperature'],
      xLabels: '5min',
      labels: ['Temperatura'],
      dateFormat: function (x) {
        return new Date(x * 1000).toLocaleFormat();
      }
    });

    $.getJSON('/temperatures/today', function(data) {
      graph.setData(data);
    })

    setInterval(function() {
      $.getJSON('/temperatures/today', function(data) {
        graph.setData(data);
      })
    },150000)

    var ws = new WebSocket('ws://' + window.location.host + window.location.pathname);
    ws.onmessage = function(event) {
      var message = JSON.parse(event.data);
      console.log(message);
      switch(message.type) {
        case 'lights':
          setSwitchState(message.enabled);
          break;
        case 'temperature':
          $('#temperature').text(message.value);
          break;
      }
    };
  });
